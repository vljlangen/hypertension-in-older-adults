---
title: "The Natural History of Hypertension in Older Adults: A Study of Two Finnish Generational Cohorts Born 20 Years Apart - diastolic BP analyses"
output: pdf_document
classoption: landscape
date: "2023-05-22"
---



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Load packages

# First pacman
library(pacman)

# Load the rest
p_load(ggplot2, ggthemes, dplyr, knitr, kableExtra, here, tidyverse, showtext)

 
# Tell the "here" package where you are right now - i.e. tell the location of the file you are running right now

here::i_am("article1/Fig2_DBP_color.Rmd")

# After that, you can check where the project root is by running "here()"

here()

#  Load the datasets using {here} package
article1tuva_file <- here("data", "tuva.rds")
article1utuva_file <- here("data", "utuva.rds")

article1tuva <- readRDS(article1tuva_file)
article1utuva <- readRDS(article1utuva_file)

# Clean up variables
rm(article1tuva_file, article1utuva_file)


# Format the kable styling
bs_style <- c("striped", "bordered")

options(kable_styling_bootstrap_options = bs_style)

```
<br><br><br><br>
 


# Exclusion of participants in the baseline without data for SBP and/or DBP
<br><br>

We will exclude those who don't have both an SBP and a DBP reading in the baseline.

TUVA1:


```{r exclusion_tuva1, echo=FALSE}

# TUVA1
article1tuva <- article1tuva %>% drop_na(SRR_70_istuen, SRRD_70_istuen)
article1tuva %>% nrow()


```


UTUVA1:

```{r exclusion_utuva1, echo=FALSE}
# UTUVA1
article1utuva <- article1utuva %>% drop_na(B8_3_A7isys_U70, B8_3_A7idia_U70)
article1utuva %>% nrow()

```







# Introduce a custom function to calculate 95% confidence intervals

 
<br>
```{r custom_function}

ci_95_upper <- function(x) {
  ci <- t.test(x, na.action = na.omit)$conf.int
  upper_bound <- ci[2]
  return(upper_bound)
}
 

```
<br><br><br>




 
# Calculate means and 95% confidence intervals for plotting


## First, calculate statistics for Tuva

<br>
```{r statistics_tuva_part1}

DBP70_tuva_mean <- mean(article1tuva$SRRD_70_istuen, na.rm = T)
DBP70_tuva_mean

DBP70_tuva_upper <- ci_95_upper(article1tuva$SRRD_70_istuen)
DBP70_tuva_upper


DBP80_tuva_mean <- mean(article1tuva$SRRD_80_istuen, na.rm = T)
DBP80_tuva_mean

DBP80_tuva_upper <- ci_95_upper(article1tuva$SRRD_80_istuen)
DBP80_tuva_upper



DBP85_tuva_mean <- mean(article1tuva$SRRD_istuen_85, na.rm = T)
DBP85_tuva_mean

DBP85_tuva_upper <- ci_95_upper(article1tuva$SRRD_istuen_85)
DBP85_tuva_upper



DBP90_tuva_mean <- mean(article1tuva$SRRD_90_istuen, na.rm = T)
DBP90_tuva_mean

DBP90_tuva_upper <- ci_95_upper(article1tuva$SRRD_90_istuen)
DBP90_tuva_upper

 



```

\newpage

```{r statistics_tuva_part2}

# Mean (and SD) of tuva5 is trickier as the variable names are not human-readable.
#
# First explore all BP variables (except the orthostatic test) in tuva5
# with the following code.
#
# What the code does:
#
# 1. select only BP variables (except the orthostatic test)
# 2. filter out NAs (in this data frame they are coded as "")
# 3. displays the resulting data frame

article1tuva %>% select(
  FYSMIT6b1a,
  FYSMIT6b1b,
  FYSMIT6b1c,
  FYSMIT6b2a,
  FYSMIT6b2b,
  FYSMIT6b2c
) %>%  filter_all(any_vars(. != ""))  %>% head(n=10) %>% kable()


# With the above code we can instantly see that:
#
# 1. FYSMIT6b1b is the 1st sitting DBP reading
# 2. FYSMIT6b2b is the 2nd sitting DBP reading

# We will only use the 1st reading, as some other time points only
# have the 1st reading


# Pay attention that the DBP variable here is not numeric

article1tuva$FYSMIT6b1b %>% is.numeric()
article1tuva$FYSMIT6b1b %>% is.character()

# Turn numeric, calculate mean, store in a vector, with 2 alternative methods

# Mean (and SD), 1st method

DBP95_tuva_mean <- article1tuva$FYSMIT6b1b %>% as.numeric() %>% mean(na.rm = T)
DBP95_tuva_mean

DBP95_tuva_upper <- article1tuva$FYSMIT6b1b %>% as.numeric() %>% ci_95_upper()
DBP95_tuva_upper



# Mean, 2nd method
#
# (pay attention that mean() cannot be run on data frames,
#  that's why summarize_all is used)

article1tuva %>%
      select(FYSMIT6b1b) %>%
      mutate_all(as.numeric) %>% 
      na.omit() %>%
      summarize_all(mean) 




```
<br><br><br>


 

## Thereafter for utuva

<br>
```{r statistics_utuva}


##################################################################
##          Calculate means for Utuva, store in vectors         ##
##################################################################


# For utuva1 (utuva70), let's explore the BP variables first 

article1utuva %>% select(

B8_3_A7msys_U70,
B8_3_A7mdia_U70,
B8_3_A7isys_U70,
B8_3_A7idia_U70,
B8_3_A7ssys_U70,
B8_3_A7sdia_U70
)  %>% head(n= 8) %>% kable()

# DBP for utuva70

DBP70_utuva_mean <- mean(article1utuva$B8_3_A7idia_U70, na.rm = T)
DBP70_utuva_mean

DBP70_utuva_upper <- ci_95_upper(article1utuva$B8_3_A7idia_U70)
DBP70_utuva_upper



# utuva2 (utuva75) exploration:

article1utuva %>% select(

B10b_A7_1_1_U75,
B10b_A7_1_2_U75,
B10b_A7_2_1_U75,
B10b_A7_2_2_U75,
B10b_A7_3_1_U75,
B10b_A7_3_2_U75
)   %>% head(n= 20) %>% kable()



# DBP for utuva75

DBP75_utuva_mean <- mean(article1utuva$B10b_A7_2_2_U75, na.rm = T)
DBP75_utuva_mean

DBP75_utuva_upper <- ci_95_upper(article1utuva$B10b_A7_2_2_U75)
DBP75_utuva_upper



# utuva80 exploration:


article1utuva %>% select(

RR_syst_istuen_U80,
RR_diast_ist_U80,
RR_syst_seisten_U80,
RR_diast_seisten_U80,
RR_syst_maaten_U80,
RR_diast_maaten_U80
)   %>% head(n= 20)  %>% kable()


# DBP for utuva80:

# Pay attention that the SBP variable here is not numeric

article1utuva$RR_diast_ist_U80 %>% is.numeric()
article1utuva$RR_diast_ist_U80 %>% is.character()

# Turn numeric, calculate mean, store in a vector
 


utuva_corrected <-
  article1utuva %>%
  select(RR_diast_ist_U80) %>%
  mutate_all(as.numeric) %>% 
  na.omit() %>%
  filter_all(any_vars(. < 400)) 

DBP80_utuva_mean <- utuva_corrected$RR_diast_ist_U80 %>% mean(na.rm = T)
DBP80_utuva_mean

DBP80_utuva_upper <- utuva_corrected$RR_diast_ist_U80 %>% ci_95_upper()
DBP80_utuva_upper



```
<br><br><br>


# Store the statistics that were created above to a custom data frame (to a tribble)

<br>
```{r tribble}



data_for_plot <- 

tibble::tribble(
  ~Age, ~Cohort,          ~DBP_mean,      ~upperCI,
   70.9,  "1920-born TUVA cohort",  DBP70_tuva_mean,  DBP70_tuva_upper,
   80.2,  "1920-born TUVA cohort",  DBP80_tuva_mean,  DBP80_tuva_upper,
   85.5,  "1920-born TUVA cohort",  DBP85_tuva_mean,  DBP85_tuva_upper,
   89.5,  "1920-born TUVA cohort",  DBP90_tuva_mean,  DBP90_tuva_upper,
   94.9,  "1920-born TUVA cohort",  DBP95_tuva_mean,  DBP95_tuva_upper,
   71.4, "1940-born UTUVA cohort", DBP70_utuva_mean,   DBP70_utuva_upper,
   76.2, "1940-born UTUVA cohort", DBP75_utuva_mean,   DBP75_utuva_upper,
   81.6, "1940-born UTUVA cohort", DBP80_utuva_mean,   DBP80_utuva_upper
  )

 



```
<br><br><br>


# Finally, create the plot
 
<br>
```{r fig2}


# Load specific font from Google Fonts
font_add_google("Rosario", family = "rosario")

# Invoke showtext
showtext_auto()

# Define your custom colors

custom_colors <- c("1920-born TUVA cohort" = "#5C7DB2", "1940-born UTUVA cohort" = "#E29A3F")
shape_mapping <- c("1920-born TUVA cohort" = 19, "1940-born UTUVA cohort" = 15)  


fig2 <-
ggplot(data_for_plot, aes(x = Age, y = DBP_mean, color = Cohort, shape = Cohort)) +
  
  geom_line(linewidth = 0.8) +

  geom_point(size = 2.5) +
  
  scale_shape_manual(values = shape_mapping) + # Apply the shape mapping

  geom_errorbar(aes(ymin=DBP_mean-upperCI+DBP_mean,
                    ymax=upperCI),
               width=0.4,
                size=0.8,
                ) +  
 
  scale_color_manual(values = custom_colors) +  # Manually set fill colors

  
  labs(x = "Age", y = "DBP mean") +
  
  theme_classic(base_size = 15, base_family = "rosario") +  
    

  theme(
    legend.position = c(.212, .96)) +
  
   
  theme(legend.title=element_blank()) +
  
  
  
  scale_x_continuous(breaks = seq(70, 95, 5),
                     name = "Age (years)") +
  scale_y_continuous(breaks = seq(70, 100, 10), limits = c(70, 100),
                     name = "Diastolic blood pressure (mmHg)",
                     expand = c(0, 0)) +

  theme(axis.title.x = element_text(face = "bold",
    margin = margin(t = 15, unit = "pt")),  # Adjust margin for x-axis title
    axis.title.y = element_text(face = "bold",
      margin = margin(r = 15, unit = "pt"))) +  # Adjust margin for y-axis title

  
# The year labels of TUVA:
annotate("text", x=70.9, y=87.5, label="1991", color="black", size=4,
               family = "rosario") +
annotate("text", x=80.2, y=86.5, label="2000", color="black", size=4,
               family = "rosario") +
annotate("text", x=85.5, y=88.7, label="2006", color="black", size=4,
               family = "rosario") +
annotate("text", x=89.5, y=86.7, label="2010", color="black", size=4,
               family = "rosario") +
annotate("text", x=94.9, y=80, label="2015", color="black", size=4,
               family = "rosario") +

# The year labels of UTUVA:
annotate("text", x=71.4, y=82.5, label="2011", color="black", size=4,
               family = "rosario") +
annotate("text", x=76.2, y=78.5, label="2016", color="black", size=4,
               family = "rosario") +
annotate("text", x=81.6, y=81, label="2021", color="black", size=4,
               family = "rosario")


fig2

```
<br><br><br>



# Export the fig. 2 to PDF and PNG

We will conclude this R Markdown file by exporting the Fig. 2 to a PDF and PNG file.



```{r export, echo=FALSE}


# Save as PNG with dpi specified
#ggsave("Fig2_DBP_dpi600.png", fig2, dpi = 600, bg = "white")
 

# Save as PDF with dpi specified
ggsave("Fig2_DBP_dpi600.pdf", fig2, dpi = 600)


```

