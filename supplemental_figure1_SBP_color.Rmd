---
title: "The Natural History of Hypertension in Older Adults: A Study of Two Finnish Generational Cohorts Born 20 Years Apart - supplemental figure, systolic BP analyses"
output: pdf_document
classoption: landscape
date: "`r Sys.Date()`"
---



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Load packages

# First pacman
library(pacman)

# Load the rest
p_load(ggplot2, ggthemes, dplyr, knitr, kableExtra, tidyverse, showtext)

# Load the dataset
article1tuva <- readRDS("../data/tuva.rds")
article1utuva <- readRDS("../data/utuva.rds")



```
<br><br><br><br>
 



# Exclusion of participants in the baseline without data for SBP and/or DBP
<br><br>

We will exclude those who don't have both an SBP and a DBP reading in the baseline.

TUVA1:


```{r exclusion_tuva1, echo=FALSE}

# TUVA1
article1tuva <- article1tuva %>% drop_na(SRR_70_istuen, SRRD_70_istuen)
article1tuva %>% nrow()


```


UTUVA1:

```{r exclusion_utuva1, echo=FALSE}
# UTUVA1
article1utuva <- article1utuva %>% drop_na(B8_3_A7isys_U70, B8_3_A7idia_U70)
article1utuva %>% nrow()

```





# Introduce a custom function to calculate 95% confidence intervals

There is no ready function in R to calculate 95% CIs. However, such a custom function can be easily made. We only need a function for the upper bound (lower can be calculated later on the spot).
 
<br>
```{r custom_function}

ci_95_upper <- function(x) {
  ci <- t.test(x, na.action = na.omit)$conf.int
  upper_bound <- ci[2]
  return(upper_bound)
}
 

```
<br><br><br>




 
# Calculate means and 95% confidence intervals for plotting

Note that only one of the 95% CI bounds is needed for the plot (the other can be calculated on the spot)

## For the supplemental figure, only the SBP readings of those reaching 95 years in TUVA are needed

<br>
```{r statistics_tuva_part1}

## Retain only those of TUVA who finished the study as 95-year-olds
 
# Convert "" to NA
article1tuva <- article1tuva %>% 
  mutate(mittaukset_95_v = na_if(FYSMIT_PVM_95, ""))

# Drop all who had NA readings in FYSMIT_PVM_95 (who didn't show up at 95-year-olds' examination)
article1tuva <- article1tuva %>% drop_na(mittaukset_95_v)

# Display the n of this supplemental figure
nrow(article1tuva)


# Calculate mean and SD of tuva1
SBP70_tuva_mean <- mean(article1tuva$SRR_70_istuen, na.rm = T)
SBP70_tuva_mean

SBP70_tuva_upper <- ci_95_upper(article1tuva$SRR_70_istuen)
SBP70_tuva_upper



# Mean and SD of tuva2
SBP80_tuva_mean <- mean(article1tuva$SRR_80_istuen, na.rm = T)
SBP80_tuva_mean

SBP80_tuva_upper <- ci_95_upper(article1tuva$SRR_80_istuen)
SBP80_tuva_upper



# Mean and SD of tuva3
SBP85_tuva_mean <- mean(article1tuva$SRR_istuen_85, na.rm = T)
SBP85_tuva_mean

SBP85_tuva_upper <- ci_95_upper(article1tuva$SRR_istuen_85)
SBP85_tuva_upper



# Mean of tuva4
SBP90_tuva_mean <- mean(article1tuva$SRR_90_istuen, na.rm = T)
SBP90_tuva_mean

SBP90_tuva_upper <- ci_95_upper(article1tuva$SRR_90_istuen)
SBP90_tuva_upper

 



```

\newpage

```{r statistics_tuva_part2}

# Mean (and SD) of tuva5 is trickier as the variable names are not human-readable.
#
# First explore all BP variables (except the orthostatic test) in tuva5
# with the following code.
#
# What the code does:
#
# 1. select only BP variables (except the orthostatic test)
# 2. filter out NAs (in this data frame they are coded as "")
# 3. displays the resulting data frame

article1tuva %>% select(
  FYSMIT6b1a,
  FYSMIT6b1b,
  FYSMIT6b1c,
  FYSMIT6b2a,
  FYSMIT6b2b,
  FYSMIT6b2c
) %>%  filter_all(any_vars(. != ""))  %>% head(n=10) %>% kable()


# With the above code we can instantly see that:
#
# 1. FYSMIT6b1a is the 1st sitting SBP reading
# 2. FYSMIT6b2a is the 2nd sitting SBP reading

# We will only use the 1st reading, as some other time points only
# have the 1st reading


# Pay attention that the SBP variable here is not numeric

article1tuva$FYSMIT6b1a %>% is.numeric()
article1tuva$FYSMIT6b1a %>% is.character()

# Turn numeric, calculate mean, store in a vector, with 2 alternative methods

# Mean (and SD), 1st method

SBP95_tuva_mean <- article1tuva$FYSMIT6b1a %>% as.numeric() %>% mean(na.rm = T)
SBP95_tuva_mean

SBP95_tuva_upper <- article1tuva$FYSMIT6b1a %>% as.numeric() %>% ci_95_upper()
SBP95_tuva_upper



# Mean, 2nd method
#
# (pay attention that mean() cannot be run on data frames,
#  that's why summarize_all is used)

article1tuva %>%
      select(FYSMIT6b1a) %>%
      mutate_all(as.numeric) %>% 
      na.omit() %>%
      summarize_all(mean) 




```
<br><br><br>


 


# Store the statistics that were created above to a custom data frame (to a tribble)

<br>
```{r tribble}



data_for_plot <- 

tibble::tribble(
  ~Age, ~Cohort,          ~SBP_mean,      ~upperCI,
   70.9,  "1920-born TUVA cohort",  SBP70_tuva_mean,  SBP70_tuva_upper,
   80.1,  "1920-born TUVA cohort",  SBP80_tuva_mean,  SBP80_tuva_upper,
   85.5,  "1920-born TUVA cohort",  SBP85_tuva_mean,  SBP85_tuva_upper,
   89.5,  "1920-born TUVA cohort",  SBP90_tuva_mean,  SBP90_tuva_upper,
   94.9,  "1920-born TUVA cohort",  SBP95_tuva_mean,  SBP95_tuva_upper

  )


```
<br><br><br>


# Calculate the mean dates (mean years) of the examination time points of TUVA


```{r date_calculations, echo=FALSE}


#TUVA70
adrianas_data <- article1tuva %>%
  mutate(tuva1_date=as.Date(PAIVAMA_70_PVM, format = "%d.%m.%Y"))

#class(adrianas_data$tuva1_date)
         
mean_tuva1_date <- mean(as.numeric(adrianas_data$tuva1_date), na.rm= TRUE)
mean_tuva1_date <- as.Date(mean_tuva1_date, origin = "1970-01-01")


#TUVA80

adrianas_data <- article1tuva %>%
  mutate(tuva2_date=as.Date(PAIVAMA_PVM_80, format = "%d.%m.%Y"))

#class(adrianas_data$tuva2_date)
         
mean_tuva2_date <- mean(as.numeric(adrianas_data$tuva2_date), na.rm= TRUE)
mean_tuva2_date <- as.Date(mean_tuva2_date, origin = "1970-01-01")


#TUVA85

adrianas_data <- article1tuva %>%
  mutate(tuva3_date=as.Date(PAIVAMA_PVM_85, format = "%d.%m.%Y"))

#class(adrianas_data$tuva3_date)
         
mean_tuva3_date <- mean(as.numeric(adrianas_data$tuva3_date), na.rm= TRUE)
mean_tuva3_date <- as.Date(mean_tuva3_date, origin = "1970-01-01")


#TUVA90

tuva4_numeric <-article1tuva %>%
  mutate(numeric_Tutkimuspaivamaara_F90 = as.numeric(Tutkimuspaivamaara_F90)) %>%
  select(numeric_Tutkimuspaivamaara_F90) %>%
  filter(!is.na(numeric_Tutkimuspaivamaara_F90) & numeric_Tutkimuspaivamaara_F90 != "") %>%
  filter(numeric_Tutkimuspaivamaara_F90 > 1)

my_vector <- tuva4_numeric %>%
  select(numeric_Tutkimuspaivamaara_F90) %>%
  as.vector()

my_vector_numeric <- as.numeric(unlist(my_vector))

my_vector_mean <- mean(my_vector_numeric)

real_date_tuva4 <- as.Date(my_vector_mean, origin = "1899-12-30") 

#class(real_date_tuva4)


#TUVA95

adrianas_data <- article1tuva %>%
  mutate(tuva5_date=as.Date(PAIVAMAA_95, format = "%d.%m.%Y"))

#class(adrianas_data$tuva5_date)
         
mean_tuva5_date <- mean(as.numeric(adrianas_data$tuva5_date), na.rm= TRUE)
mean_tuva5_date <- as.Date(mean_tuva5_date, origin = "1970-01-01")


real_dates <- data.frame(time_point           = c("TUVA1","TUVA2","TUVA3","TUVA4","TUVA5"),
                        mean_examination_date = c(mean_tuva1_date, mean_tuva2_date, mean_tuva3_date,
                                                  real_date_tuva4, mean_tuva5_date))

real_dates %>% kable()



```

# Finally, create the plot
 
<br>
```{r fig1, echo=FALSE}


# Load specific font from Google Fonts
font_add_google("Rosario", family = "rosario")

# Invoke showtext
showtext_auto()

# Define your custom colors

custom_colors <- c("1920-born TUVA cohort" = "#5C7DB2", "1940-born UTUVA cohort" = "#E29A3F")
shape_mapping <- c("1920-born TUVA cohort" = 19, "1940-born UTUVA cohort" = 15)  


fig1 <-
ggplot(data_for_plot, aes(x = Age, y = SBP_mean, color = Cohort, shape = Cohort)) +
  
  geom_line(linewidth = 0.8) +

  geom_point(size = 2.5) +
  
  scale_shape_manual(values = shape_mapping) + # Apply the shape mapping
  
  geom_errorbar(aes(ymin=SBP_mean-upperCI+SBP_mean,
                    ymax=upperCI),
                width=0.5,
                width=0.4,
                size=0.8,
                ) +  
  
  scale_color_manual(values = custom_colors) +  # Manually set fill colors

  
  labs(x = "Age", y = "SBP mean") +

  theme_classic(base_size = 15, base_family = "rosario") +  
    
 
  
  scale_x_continuous(breaks = seq(70, 95, 5),
                     name = "Age (years)") +
  scale_y_continuous(breaks = seq(140, 190, 10), limits = c(140, 190),
                     name = "Systolic blood pressure (mmHg)",
                     expand = c(0, 0)) +

  
   theme(axis.title.x = element_text(face = "bold",
    margin = margin(t = 15, unit = "pt")),  # Adjust margin for x-axis title
    axis.title.y = element_text(face = "bold",
      margin = margin(r = 15, unit = "pt"))) +  # Adjust margin for y-axis title
  
  
  
# The year labels of TUVA:
annotate("text", x=70.9, y=163.9, label="1991", color="black", size=4,
               family = "rosario") +
annotate("text", x=80.1, y=175.2, label="2000", color="black", size=4,
               family = "rosario") +
annotate("text", x=85.5, y=185.9, label="2005", color="black", size=4,
               family = "rosario") +
annotate("text", x=89.5, y=184, label="2010", color="black", size=4,
               family = "rosario") +
annotate("text", x=94.9, y=164.9, label="2015", color="black", size=4,
               family = "rosario") +


# The n label:
annotate("text", x=70, y=189, label="Only participants reaching", color="black", size=4, hjust = 0,
               family = "rosario") +
annotate("text", x=70, y=186, label="95-year-olds' evaluation", color="black", size=4, hjust = 0,
               family = "rosario") +
annotate("text", x=70, y=183, label="in TUVA study (n=55)", color="black", size=4, hjust = 0,
               family = "rosario") +

#geom_rect(aes(xmin = 84, xmax = 94, ymin = 136, ymax = 148), 
#            color = "black", fill = NA, linetype = "solid", size = 0.3)  +
  

theme(legend.position = "none")








fig1

```
<br><br><br>



# Export the fig. 1 to PDF and PNG

We will conclude this R Markdown file by exporting the Fig. 1 to a PDF and PNG file.



```{r export, echo=FALSE}


# Save as PNG with dpi specified
#ggsave("Fig_S1_SBP_dpi600.png", fig1, dpi = 600, bg = "white")
 

# Save as PDF with dpi specified
ggsave("Fig_S1_SBP_dpi600.pdf", fig1, dpi = 600)


```

 
